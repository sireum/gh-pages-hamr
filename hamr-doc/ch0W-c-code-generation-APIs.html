
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HAMR C APIs for Component Application Logic &#8212; Sireum HAMR</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/sireum.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/js/jquery-fix.js"></script>
    <script src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script src="../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../_static/hamr.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          HAMR</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="ch0X-hamr-installation.html">Download</a></li>
                <li><a href="ch00-hamr-overview.html">Doc</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html"> <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#"> <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">HAMR C APIs for Component Application Logic</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#code-organization">Code Organization</a></li>
<li><a class="reference internal" href="#thread-entry-points">Thread Entry Points</a><ul>
<li><a class="reference internal" href="#compute-entry-point-periodic-threads">Compute Entry Point – Periodic Threads</a></li>
<li><a class="reference internal" href="#compute-entry-point-sporadic-threads">Compute Entry Point – Sporadic Threads</a></li>
<li><a class="reference internal" href="#initialize-entry-point">Initialize Entry Point</a></li>
<li><a class="reference internal" href="#finalize-entry-point">Finalize Entry Point</a></li>
</ul>
</li>
<li><a class="reference internal" href="#port-communication-apis">Port Communication APIs</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="hamr-c-apis-for-component-application-logic">
<span id="ch0w-c-code-generation-apis"></span><h1>HAMR C APIs for Component Application Logic<a class="headerlink" href="#hamr-c-apis-for-component-application-logic" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id1">Overview</a></p></li>
<li><p><a class="reference internal" href="#code-organization" id="id2">Code Organization</a></p></li>
<li><p><a class="reference internal" href="#thread-entry-points" id="id3">Thread Entry Points</a></p>
<ul>
<li><p><a class="reference internal" href="#compute-entry-point-periodic-threads" id="id4">Compute Entry Point – Periodic Threads</a></p></li>
<li><p><a class="reference internal" href="#compute-entry-point-sporadic-threads" id="id5">Compute Entry Point – Sporadic Threads</a></p></li>
<li><p><a class="reference internal" href="#initialize-entry-point" id="id6">Initialize Entry Point</a></p></li>
<li><p><a class="reference internal" href="#finalize-entry-point" id="id7">Finalize Entry Point</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#port-communication-apis" id="id8">Port Communication APIs</a></p></li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id1">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>C is one of the programming languages that HAMR supports for implementing the application logic of AADL components.  HAMR C-based applications can be executed on MacOSX, Linux, and seL4 platforms (referred to as “HAMR C execution platforms”).</p>
<p>This chapter provides an overview of the platform-independent aspects of HAMR C-based development.  Other chapters describe how these concepts are specialized to different platforms.   Making application code as platform-independent as possible (via uniform APIs and code organization) is a goal of HAMR.  In fact, in most cases, component application code that doesn’t access underlying platform services can be moved between platforms immediately.  The system build process and platform configuration aspects are specific to the underlying platforms.</p>
<p>HAMR generates C APIs for interacting with AADL ports and skeletons for entry point methods for AADL threading.   The structure of the port APIs and threading entry points are designed to have a structure very similar to the Slang APIs and skeletons used in Chapter <a class="reference internal" href="ch04-hamr-aadl-fundamental-concepts.html#ch04-hamr-aadl-fundamental-concepts"><span class="std std-ref">AADL Computational Paradigm and HAMR Fundamental Concepts</span></a> to explain the overall AADL computational paradigm.   The discussion in this chapter assumes that the reader has read and understood the presentation in Chapter <a class="reference internal" href="ch04-hamr-aadl-fundamental-concepts.html#ch04-hamr-aadl-fundamental-concepts"><span class="std std-ref">AADL Computational Paradigm and HAMR Fundamental Concepts</span></a>.</p>
<p>HAMR also generates libaries with a variety of C functions and macros to support creation and access of values for AADL/HAMR types.</p>
<p>Behind the scenes, the HAMR C-based AADL run-time infrastructure for port-based communication and threading is derived, via the Slang transpiler, from the Slang reference model of the AADL run-time serves along with Slang-based customizations for HAMR’s C execution platforms.   This helps ensure consistency of the infrastructure’s execution semantics across different platforms.</p>
<p>A development environment for C of the developer’s choice may be used to support coding and debugging (the HAMR development team uses the <cite>JetBrains CLion IDE &lt;https://www.jetbrains.com/clion/&gt;</cite>).  HAMR generates CMAKELists.txt files (which can be used for command-line-based compilation or imported into IDEs) to coordinate compilation of HAMR C-based component and system implementations.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ToDo, From John, To Robby:</strong> Briefly describe the subset of C produced by the transpiler and any other facts about C that would impact its deployment.  Eventually, we will likely have a stand-alone chapter on the Slang transpiler.</p>
</div>
</div>
<div class="section" id="code-organization">
<h2><a class="toc-backref" href="#id2">Code Organization</a><a class="headerlink" href="#code-organization" title="Permalink to this headline">¶</a></h2>
<p>Recall from Chapter <a class="reference internal" href="ch0X-hamr-project-org-workflows.html#ch0x-hamr-project-org-workflows"><span class="std std-ref">HAMR Project Organization and Workflows</span></a> the suggested folder structure for HAMR projects.  The diagram below expands the <code class="docutils literal notranslate"><span class="pre">c</span></code> folder to show the suggested structure of HAMR C projects.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>aadl/
hamr/
├── bin/
├── src/
    ├── slang/
    └── c/
        ├── &lt;platform infrastructure code folder&gt;/
        |    ├── ...
        |    └── CMAKELists.txt
        |
        └── c-ext/
            ├── &lt;component C1 application code folder&gt;/
            |    ├── &lt;component C1&gt;.c
            |    ├── &lt;component C1&gt;_api.c
            |    └── &lt;component C1&gt;_api.h
            ├── ...
            ├── &lt;component Cn application code folder&gt;/
            ├── adapters/
            |    ├── &lt;component C1 mangled name&gt;/
            |    |    ├── &lt;component C1&gt;_adapter.c
            |    |    └── &lt;component C1&gt;_adapter.h
            |    ├── ...
            |    └── &lt;component Cn mangled name&gt;/
            |
            ├── ext.c
            ├── ext.h
            └── ipc.c
</pre></div>
</div>
<p>The <code class="file docutils literal notranslate"><span class="pre">&lt;platform</span> <span class="pre">infrastructure</span> <span class="pre">code</span> <span class="pre">folder&gt;</span></code> contains HAMR-generated infrastructure code for the chosen platform.   This code should never be modified by the developer – succesive calls to HAMR code generation will overwrite these files.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ToDo, From John, To Jason:</strong> Briefly describe the purpose of the CMAKELists.txt file.  I assume that it is the primary method of configuring the build.  Does the user ever need to modify it?  Does it get overwritten with successive calls to the code generator?</p>
</div>
<p>** CMAKELists.txt is autogenerated.   Jason notes that there are other CMAKELists.txt  The organization of <code class="file docutils literal notranslate"><span class="pre">CMAKELists.txt</span></code> and an overview of how to customize it for compilation is presented at the end of this chapter.</p>
<p>Developer-written application code goes in the file:<cite>c-ext</cite> folder, using the subfolders for each AADL thread component.  In the files <code class="file docutils literal notranslate"><span class="pre">&lt;component</span> <span class="pre">Cn&gt;.c</span></code>, HAMR will generate function skeletons for each thread entry point for the respective AADL thread component (e.g., for the compute entry point, either a <cite>time-triggered</cite> function for <cite>periodic</cite> threads, or input event handlers for <cite>sporadic</cite> threads will be generated) – all following the same structure as described in Chapter XX <strong>ToDo</strong>.   When the HAMR code generator is called successively, the <code class="file docutils literal notranslate"><span class="pre">&lt;component</span> <span class="pre">Cn&gt;.c</span></code> files <em>will not</em> be overwritten.</p>
<p>Programming the logic for the component consists of filling in code in the thread entry point skeletons.  This code will typically call functions to send and receive data over AADL ports (defined in the HAMR-generated files <code class="file docutils literal notranslate"><span class="pre">&lt;component</span> <span class="pre">C1&gt;_api.h</span></code> and <code class="file docutils literal notranslate"><span class="pre">&lt;component</span> <span class="pre">C1&gt;_api.c</span></code>).   The developer should not modify the <code class="file docutils literal notranslate"><span class="pre">&lt;component</span> <span class="pre">C1&gt;_api.h</span></code> and <code class="file docutils literal notranslate"><span class="pre">&lt;component</span> <span class="pre">C1&gt;_api.c</span></code>, and these files <em>will</em> be overwritten on successive invocations of HAMR code generation (e.g., the files may be changed to reflect changes to the component’s port declarations in the AADL model).</p>
<p>Other C files that support the application may be added (where??? <strong>ToDo</strong> – Jason complete).</p>
<p>The <code class="file docutils literal notranslate"><span class="pre">adapters/</span></code> folder (<strong>ToDo</strong> – Jason complete)</p>
<p>The <code class="file docutils literal notranslate"><span class="pre">ext.c</span></code>, <code class="file docutils literal notranslate"><span class="pre">ext.h</span></code>, and <code class="file docutils literal notranslate"><span class="pre">ipc.c</span></code> files (<strong>ToDo</strong> – Jason complete)</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ToDo, From John, To Jason:</strong></p>
<ul class="simple">
<li><p>Check/complete description of folders/files above.</p></li>
<li><p>What files contain the macros that simplify the developer’s programming?</p></li>
</ul>
</div>
</div>
<div class="section" id="thread-entry-points">
<h2><a class="toc-backref" href="#id3">Thread Entry Points</a><a class="headerlink" href="#thread-entry-points" title="Permalink to this headline">¶</a></h2>
<div class="section" id="compute-entry-point-periodic-threads">
<h3><a class="toc-backref" href="#id4">Compute Entry Point – Periodic Threads</a><a class="headerlink" href="#compute-entry-point-periodic-threads" title="Permalink to this headline">¶</a></h3>
<p>Following the structure presented in <a class="reference internal" href="ch04-hamr-aadl-fundamental-concepts.html#ch04-hamr-aadl-fundamental-concepts"><span class="std std-ref">AADL Computational Paradigm and HAMR Fundamental Concepts</span></a>, for periodic AADL thread components the root of the primary application logic for the AADL compute entry point is the <code class="docutils literal notranslate"><span class="pre">timeTriggered</span></code> function.  This function will be repeatedly invoked by the underlying AADL and platform infrastructure at the rate corresponding to the <code class="docutils literal notranslate"><span class="pre">Period</span></code> property attached to the thread component in the AADL model.</p>
<p>HAMR generates a skeleton for the <code class="docutils literal notranslate"><span class="pre">timeTriggered</span></code> function (along with some other supporting functions) in the <code class="file docutils literal notranslate"><span class="pre">&lt;component</span> <span class="pre">Cn&gt;.c</span></code> as described above.  For the building control example, the following skeleton is generated in the file <code class="file docutils literal notranslate"><span class="pre">/ext-c/TempSensor_i_Impl/TempSensor_i_Impl.c</span></code> for the <code class="docutils literal notranslate"><span class="pre">TempSensor</span></code> periodic thread.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Unit</span> <span class="nf">bc_BuildingControl_TempSensor_i_Impl_timeTriggered_</span><span class="p">(</span>
      <span class="n">STACK_FRAME</span>
      <span class="n">bc_BuildingControl_TempSensor_i_Impl</span> <span class="n">this</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// Application code goes here</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Most HAMR C functions take a <code class="docutils literal notranslate"><span class="pre">STACK_FRAME</span></code> argument to support debugging and traceability back to the higher-level Slang infrastructure.  Developers don’t need to manipulate this argument – its values are populated by the underlying infrastructure.   Its use in debugging is discussed at the end of this chapter.  Most HAMR C functions associated with a component are passed a struct <code class="docutils literal notranslate"><span class="pre">this</span></code> that contains state information for the component.  This struct information never needs to be manipulated directly by application code.  It is created by HAMR initialization infrastructure code and then updated behind the scenes by each HAMR API call (further explanation is given at the end of the chapter).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ToDo, From John, To Jason:</strong></p>
<ul class="simple">
<li><p>Check wording above</p></li>
</ul>
</div>
<p>The completed application code for this example thread includes reading the sensor value by a call to the driver for the hardware temperature sensor.  The function uses HAMR-generated APIs in <code class="file docutils literal notranslate"><span class="pre">ext-c/TempSensor_i_Impl/TempSensor_i_Impl_api.*</span></code> to interact with AADL ports to send values out of the component output ports (the <code class="docutils literal notranslate"><span class="pre">TempSensor</span></code> component does not have input ports – working with input ports is illustrated using the <code class="docutils literal notranslate"><span class="pre">TempControl</span></code> component in the section on sporadic threads below).</p>
<p>Since HAMR is designed for interoperability across multiple platforms and across programming languages including Slang and C, the function uses standardized macros and libaries for creation and access of type structures derived from AADL-level types and for other types (e.g., message strings used in logging) that are shared across Slang-supported infrastructure.</p>
<p>Comments in the code listing explain the use of the APIs and macros.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Unit</span> <span class="nf">bc_BuildingControl_TempSensor_i_Impl_timeTriggered_</span><span class="p">(</span>
      <span class="n">STACK_FRAME</span>
      <span class="n">bc_BuildingControl_TempSensor_i_Impl</span> <span class="n">this</span><span class="p">)</span> <span class="p">{</span>

   <span class="c1">// Use HAMR-provided macro to declare structure to hold temperature value retrieve via temp sensor driver</span>
   <span class="n">DeclNewbc_BuildingControl_Temperature_i</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
   <span class="c1">// Call driver function to move the temperature reading into the &quot;value&quot; structure</span>
   <span class="n">currentTempGet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

   <span class="c1">// Use auto-generated APIs in ext-c/TempSensor_i_Impl/TempSensor_i_Impl_api.h to interact with AADL ports</span>
   <span class="c1">//  .. put current temp reading in &quot;currentTemp&quot; AADL out data port</span>
   <span class="n">api_send_currentTemp__bc_BuildingControl_TempSensor_i_Impl</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
   <span class="c1">//  .. queue &quot;tempChanged&quot; event on &quot;tempChanged&quot; AADL out event port</span>
   <span class="n">api_send_tempChanged__bc_BuildingControl_TempSensor_i_Impl</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>

   <span class="c1">// Use HAMR-provided macros to declare strings interoperable with Slang infrastructure.</span>
   <span class="n">DeclNewString</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
   <span class="n">String__append</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;Sensed temperature: &quot;</span><span class="p">));</span>
   <span class="c1">// Prepare Slang compatible type structure for logging message</span>
   <span class="n">bc_BuildingControl_Temperature_i_string_</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

   <span class="c1">// send message structure to logger</span>
   <span class="n">api_logInfo__bc_BuildingControl_TempSensor_i_Impl</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>

   <span class="c1">// Recall: Following AADL semantics, all values placed in output ports using the &quot;send&quot; functions as above are held</span>
   <span class="c1">// until this function completes and are then propagated after this function completes to connected consumer</span>
   <span class="c1">// components by the underlying AADL and platform infrastructure.</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="compute-entry-point-sporadic-threads">
<h3><a class="toc-backref" href="#id5">Compute Entry Point – Sporadic Threads</a><a class="headerlink" href="#compute-entry-point-sporadic-threads" title="Permalink to this headline">¶</a></h3>
<p>Following the structure presented in <a class="reference internal" href="ch04-hamr-aadl-fundamental-concepts.html#ch04-hamr-aadl-fundamental-concepts"><span class="std std-ref">AADL Computational Paradigm and HAMR Fundamental Concepts</span></a>, for sporadic AADL thread components, the roots of the primary application logic for the AADL compute entry point are message handlers for input event and event data ports (more precisely, for input event and event data ports specified as dispatch triggers).</p>
<p>HAMR generates skeletons for message handlers for sporadic threads in the <code class="file docutils literal notranslate"><span class="pre">&lt;component</span> <span class="pre">Cn&gt;.c</span></code> as described above.  For the building control example, the following skeletons are generated in the file <code class="file docutils literal notranslate"><span class="pre">/ext-c/TempControl_i_Impl/TempControl_i_Impl.c</span></code> for the <code class="docutils literal notranslate"><span class="pre">TempControl</span></code> sporadic thread.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// HAMR-generated skeleton for fanAck input event data port</span>
<span class="n">Unit</span> <span class="nf">bc_BuildingControl_TempControl_i_Impl_handlefanAck_</span><span class="p">(</span>
     <span class="n">STACK_FRAME</span>
     <span class="n">bc_BuildingControl_TempControl_i_Impl</span> <span class="n">this</span><span class="p">,</span>
     <span class="c1">// message payload for incoming event data</span>
     <span class="n">bc_BuildingControl_FanAck_Type</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>

     <span class="c1">// Application code goes here</span>
<span class="p">}</span>

<span class="c1">// HAMR-generated skeleton for fanAck input event data port</span>
<span class="n">Unit</span> <span class="nf">bc_BuildingControl_TempControl_i_Impl_handlesetPoint_</span><span class="p">(</span>
     <span class="n">STACK_FRAME</span>
     <span class="n">bc_BuildingControl_TempControl_i_Impl</span> <span class="n">this</span><span class="p">,</span>
     <span class="c1">// message payload for incoming event data</span>
     <span class="n">bc_BuildingControl_SetPoint_i</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Application code goes here</span>
<span class="p">}</span>

<span class="c1">// HAMR-generated skeleton for tempChanged input event port</span>
<span class="n">Unit</span> <span class="nf">bc_BuildingControl_TempControl_i_Impl_handletempChanged_</span><span class="p">(</span>
     <span class="n">STACK_FRAME</span>
     <span class="n">bc_BuildingControl_TempControl_i_Impl</span> <span class="n">this</span><span class="p">)</span>
     <span class="c1">// no message payload for input event ports (only payloads for event data ports)</span>
                                               <span class="p">{</span>
    <span class="c1">// Application code goes here</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Each of these message handlers is programmed in a manner similar to the <code class="docutils literal notranslate"><span class="pre">timeTriggered</span></code> function for periodic threads – each handler uses HAMR-generated APIs in <code class="file docutils literal notranslate"><span class="pre">ext-c/TempControl_i_Impl/TempControl_i_Impl_api.*</span></code>.   For example, shown below is the implementation of the handler for the <code class="docutils literal notranslate"><span class="pre">setPoint</span></code> event data port, along with a variable declaration to store the incoming set points (so that the set point values persist and are accessible by the component across multiple dispatches).</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// declare component local variable to store set point values</span>
<span class="k">struct</span> <span class="nc">bc_BuildingControl_SetPoint_i</span> <span class="n">setPoint</span><span class="p">;</span>


<span class="c1">// completed implementation for setPoint input event data port handler</span>
<span class="n">Unit</span> <span class="nf">bc_BuildingControl_TempControl_i_Impl_handlesetPoint_</span><span class="p">(</span>
      <span class="n">STACK_FRAME</span>
      <span class="n">bc_BuildingControl_TempControl_i_Impl</span> <span class="n">this</span><span class="p">,</span>
      <span class="n">bc_BuildingControl_SetPoint_i</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>

   <span class="c1">// copy the set point values to component-local state.</span>
   <span class="n">setPoint</span> <span class="o">=</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The handler implementation for the <code class="docutils literal notranslate"><span class="pre">tempChanged</span></code> <em>event</em> port is presented below.  Note that since AADL events are simple buffer notifications (with no message payloads), there is no payload value passed to the handler (in contrast to the handler for the <em>event data</em> port above).</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Unit</span> <span class="nf">bc_BuildingControl_TempControl_i_Impl_handletempChanged_</span><span class="p">(</span>
     <span class="n">STACK_FRAME</span>
     <span class="n">bc_BuildingControl_TempControl_i_Impl</span> <span class="n">this</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Use Slang-transpiler macro for creating new strings</span>
    <span class="n">DeclNewString</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="c1">// Declare a local variable to hold the current temp structure</span>
    <span class="k">struct</span> <span class="nc">bc_BuildingControl_Temperature_i</span> <span class="n">currentTemp</span><span class="p">;</span>

    <span class="c1">// Read the current temperature from the currentTemp data port.</span>
    <span class="c1">// Note that in AADL, data ports should always have values, so if the API has a false return value</span>
    <span class="c1">// then an error message is printed in the false branch of the conditional.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">api_get_currentTemp__bc_BuildingControl_TempControl_i_Impl</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">currentTemp</span><span class="p">))</span> <span class="p">{</span>

        <span class="c1">// ToDo: From John, to Jason: I don&#39;t understand this step</span>
        <span class="k">struct</span> <span class="nc">bc_BuildingControl_Temperature_i</span> <span class="n">tempInF</span> <span class="o">=</span> <span class="n">toFahrenheit</span><span class="p">(</span><span class="n">currentTemp</span><span class="p">);</span>

        <span class="c1">// compare the `degrees` field of the temperature structure to the high set point</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tempInF</span><span class="p">.</span><span class="n">degrees</span> <span class="o">&gt;</span> <span class="n">setPoint</span><span class="p">.</span><span class="n">high</span><span class="p">.</span><span class="n">degrees</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// if current temp exceeds the high set point,</span>
            <span class="c1">// send a &quot;fan on&quot; command out of the fanCmd event data output port to cool environment</span>
            <span class="n">api_send_fanCmd__bc_BuildingControl_TempControl_i_Impl</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">FanCmd_On</span><span class="p">);</span>

            <span class="n">String__append</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;Sent fan command: &quot;</span><span class="p">));</span>
            <span class="n">bc_BuildingControl_FanCmd_Type_string_</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">FanCmd_On</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tempInF</span><span class="p">.</span><span class="n">degrees</span> <span class="o">&lt;</span> <span class="n">setPoint</span><span class="p">.</span><span class="n">low</span><span class="p">.</span><span class="n">degrees</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// if current temp is less than the low set point,</span>
            <span class="c1">// send a &quot;fan off&quot; command out of the fanCmd event data output port to stop cooling environment</span>

            <span class="n">api_send_fanCmd__bc_BuildingControl_TempControl_i_Impl</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">FanCmd_Off</span><span class="p">);</span>

            <span class="n">String__append</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;Sent fan command: &quot;</span><span class="p">));</span>
            <span class="n">bc_BuildingControl_FanCmd_Type_string_</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">FanCmd_Off</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// if current temp is between high and low set points (inclusive)</span>
            <span class="c1">// don&#39;t change the on/off status of the fan</span>
            <span class="n">String__append</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;Temperature ok:&quot;</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="c1">// creating a string that includes the current temperature for logging purposes</span>
        <span class="n">String__append</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot; - &quot;</span><span class="p">));</span>
        <span class="n">bc_BuildingControl_Temperature_i_string_</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">currentTemp</span><span class="p">);</span>

        <span class="n">api_logInfo__bc_BuildingControl_TempControl_i_Impl</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unexpected: tempSensor should have also sent something on its currentTemp port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="initialize-entry-point">
<h3><a class="toc-backref" href="#id6">Initialize Entry Point</a><a class="headerlink" href="#initialize-entry-point" title="Permalink to this headline">¶</a></h3>
<p>As described in <a class="reference internal" href="ch04-hamr-aadl-fundamental-concepts.html#ch04-hamr-aadl-fundamental-concepts"><span class="std std-ref">AADL Computational Paradigm and HAMR Fundamental Concepts</span></a>, each AADL thread has an <em>initialize entry point</em> that is called during system initialization before system scheduling takes over the dispatching for all thread compute entry points.</p>
<p>The application developer fills in the code</p>
<p>C APIs Domain APIs</p>
</div>
<div class="section" id="finalize-entry-point">
<h3><a class="toc-backref" href="#id7">Finalize Entry Point</a><a class="headerlink" href="#finalize-entry-point" title="Permalink to this headline">¶</a></h3>
<p>(not fully implemented now)</p>
</div>
</div>
<div class="section" id="port-communication-apis">
<h2><a class="toc-backref" href="#id8">Port Communication APIs</a><a class="headerlink" href="#port-communication-apis" title="Permalink to this headline">¶</a></h2>
<p>Following a structure similar to HAMR Slang code generation, for each AADL thread component, HAMR will generate APIs for interacting with the ports of the component.  The APIs generated for <code class="docutils literal notranslate"><span class="pre">TempControl</span></code> component are illustrated below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**********************************************************************************</span>
<span class="cm">* fanCmd : out event data port FanCmd</span>
<span class="cm">**********************************************************************************/</span>

<span class="n">Unit</span> <span class="nf">BuildingControl_TempControl_i_sendfanCmd</span><span class="p">(</span>
      <span class="n">building_control_gen_mixed_excludes_BuildingControl_TempControl_i_Impl</span> <span class="n">this</span><span class="p">,</span>
      <span class="n">building_control_gen_mixed_excludes_BuildingControl_FanCmd</span> <span class="n">value</span><span class="p">);</span>


<span class="cm">/**********************************************************************************</span>
<span class="cm">* currentTemp : in data port Temperature.i</span>
<span class="cm">***********************************************************************************/</span>

<span class="kt">bool</span> <span class="nf">BuildingControl_TempControl_i_getcurrentTemp</span><span class="p">(</span>
      <span class="n">building_control_gen_mixed_excludes_BuildingControl_TempControl_i_Impl</span> <span class="n">this</span><span class="p">,</span>
      <span class="n">building_control_gen_mixed_excludes_BuildingControl_Temperature_i</span> <span class="n">value</span><span class="p">);</span>

<span class="cm">/**********************************************************************************</span>
<span class="cm">* tempChanged : in event port</span>
<span class="cm">**********************************************************************************/</span>

<span class="kt">bool</span> <span class="nf">BuildingControl_TempControl_i_gettempChanged</span><span class="p">(</span>
      <span class="n">building_control_gen_mixed_excludes_BuildingControl_TempControl_i_Impl</span> <span class="n">this</span><span class="p">,</span>
      <span class="n">art_Empty</span> <span class="n">value</span><span class="p">);</span>

<span class="cm">/**********************************************************************************</span>
<span class="cm">* fanAck : in event data port FanAck</span>
<span class="cm">**********************************************************************************/</span>

<span class="kt">bool</span> <span class="nf">BuildingControl_TempControl_i_getfanAck</span><span class="p">(</span>
      <span class="n">building_control_gen_mixed_excludes_BuildingControl_TempControl_i_Impl</span> <span class="n">this</span><span class="p">,</span>
      <span class="n">building_control_gen_mixed_excludes_BuildingControl_FanAck</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>

<span class="cm">/**********************************************************************************</span>
<span class="cm">* setPoint : in event data port SetPoint.i</span>
<span class="cm">**********************************************************************************/</span>

<span class="kt">bool</span> <span class="nf">BuildingControl_TempControl_i_getsetPoint</span><span class="p">(</span>
      <span class="n">building_control_gen_mixed_excludes_BuildingControl_TempControl_i_Impl</span> <span class="n">this</span><span class="p">,</span>
      <span class="n">building_control_gen_mixed_excludes_BuildingControl_SetPoint_i</span> <span class="n">value</span><span class="p">);</span>

<span class="cm">/**********************************************************************************</span>
<span class="cm">* logging methods</span>
<span class="cm">**********************************************************************************/</span>

<span class="kt">void</span> <span class="nf">BuildingControl_TempControl_i_logInfo</span><span class="p">(</span>
      <span class="n">building_control_gen_mixed_excludes_BuildingControl_TempControl_i_Impl</span> <span class="n">this</span><span class="p">,</span>
      <span class="n">String</span> <span class="n">str</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">BuildingControl_TempControl_i_logDebug</span><span class="p">(</span>
      <span class="n">building_control_gen_mixed_excludes_BuildingControl_TempControl_i_Impl</span> <span class="n">this</span><span class="p">,</span>
      <span class="n">String</span> <span class="n">str</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">BuildingControl_TempControl_i_logError</span><span class="p">(</span>
      <span class="n">building_control_gen_mixed_excludes_BuildingControl_TempControl_i_Impl</span> <span class="n">this</span><span class="p">,</span>
      <span class="n">String</span> <span class="n">str</span><span class="p">);</span>
</pre></div>
</div>
<p>Each API is passed a struct <code class="docutils literal notranslate"><span class="pre">this</span></code> that contains state information about the component.  This struct information never needs to be manipulated directly by application code.  It is created by initialization infrastructure code and then updated behind the scenes by each HAMR API calls.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ToDo, From John, To Jason:</strong></p>
<ul class="simple">
<li><p>Give the intuition of the <code class="docutils literal notranslate"><span class="pre">this</span></code> structure and indicate where the information for this structure is defined.</p></li>
</ul>
</div>
<p>The design of the APIs above does not have the flavor of hand-written C code, but it is constructed in this way to enable the C code to interoperate with code generated for out HAMR component implementations written in Slang and CakeML.</p>
<p>In the API for <code class="docutils literal notranslate"><span class="pre">out</span> <span class="pre">event</span> <span class="pre">data</span> <span class="pre">port</span></code> <code class="docutils literal notranslate"><span class="pre">sendfanCmd</span></code>,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Unit</span> <span class="nf">building_control_gen_mixed_excludes_BuildingControl_TempControl_i_Impl_handletempChanged_</span><span class="p">(</span>
      <span class="n">STACK_FRAME</span>
      <span class="n">building_control_gen_mixed_excludes_BuildingControl_TempControl_i_Impl</span> <span class="n">this</span><span class="p">)</span> <span class="p">{</span>

   <span class="n">DeclNewString</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
   <span class="k">struct</span> <span class="nc">building_control_gen_mixed_excludes_BuildingControl_Temperature_i</span> <span class="n">currentTemp</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">BuildingControl_TempControl_i_getcurrentTemp</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">currentTemp</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">struct</span> <span class="nc">building_control_gen_mixed_excludes_BuildingControl_Temperature_i</span> <span class="n">tempInF</span> <span class="o">=</span> <span class="n">toFahrenheit</span><span class="p">(</span><span class="n">currentTemp</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">tempInF</span><span class="p">.</span><span class="n">degrees</span> <span class="o">&gt;</span> <span class="n">setPoint</span><span class="p">.</span><span class="n">high</span><span class="p">.</span><span class="n">degrees</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">BuildingControl_TempControl_i_sendfanCmd</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">FanCmd_On</span><span class="p">);</span>

            <span class="n">String__append</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;Sent fan command: &quot;</span><span class="p">));</span>
            <span class="n">building_control_gen_mixed_excludes_BuildingControl_FanCmd_string_</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">FanCmd_On</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tempInF</span><span class="p">.</span><span class="n">degrees</span> <span class="o">&lt;</span> <span class="n">setPoint</span><span class="p">.</span><span class="n">low</span><span class="p">.</span><span class="n">degrees</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">BuildingControl_TempControl_i_sendfanCmd</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">FanCmd_Off</span><span class="p">);</span>

            <span class="n">String__append</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;Sent fan command: &quot;</span><span class="p">));</span>
            <span class="n">building_control_gen_mixed_excludes_BuildingControl_FanCmd_string_</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">FanCmd_Off</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
            <span class="n">String__append</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;Temperature ok:&quot;</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="n">String__append</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot; - &quot;</span><span class="p">));</span>
      <span class="n">building_control_gen_mixed_excludes_BuildingControl_Temperature_i_string_</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">currentTemp</span><span class="p">);</span>
      <span class="n">BuildingControl_TempControl_i_logInfo</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unexpected: tempSensor should have also sent something on its currentTemp port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>CMAKELists</p>
<p>STACK_FRAME</p>
</div>
</div>


    </div>
      
  </div>
</div>

  </body>
</html>